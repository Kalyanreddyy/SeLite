<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript;version=1.7">
            "use strict";
            
            var OBJECT_KEYS= "OBJECT_KEYS"; // My 'secret' field in the target object, that keeps an array, which is an ordered list of the keys
            
            var sortedObjectProxyHandler= {
                enumerate: function( target ) {throw new Error('enumerate() called');
                    return target[OBJECT_KEYS];
                },
                // See a comment for 'for(prop in proxy)' at https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy and https://bugzilla.mozilla.org/show_bug.cgi?id=783829
                // It's unclear whether this should be an iterator, or return a function that is an iterator, or it should return an array.
                // Either way, it's not called in Firefox 22 neither in Firefox 23b02.
                iterate: function( target ) {throw new Error('iterate() called');
                    for( var i=0; i<target[OBJECT_KEYS].length; i++ ) {
                        yield target[OBJECT_KEYS][i];
                    }
                },
                keys: function( target ) {
                    return target[OBJECT_KEYS];
                },
                has: function(target, name) {
                    return target[OBJECT_KEYS].indexOf(name)>=0;
                }
            };
            
            /** This creates an object with sorted keys (useful if you have negative numeric keys). Only the initial fields work.
                Not useful in general - this is a cut down version of my implementation, to illustrate the problem with for( .. in ..) iteration
                @param keys array of string/mixed key names (non-strings will be converted to strings automatically by JS)
                @param values array of mixed, values, for respective keys
                @return a new proxy object to a new target object, which should honour the order of keys as in keys parameter, but it doesn't
            */
            function sortedObject( keys, values ) {
                if( keys.length!=values.length ) {
                    throw new Error( "keys[] and values[] must have same length" );
                }
                var target= {};
                target[OBJECT_KEYS]= [];
                for( var i=0; i<keys.length; i++ ) {
                    if( keys[i]===OBJECT_KEYS ) {
                        throw Error( OBJECT_KEYS+ ' is a special key. Do not use.' );
                    }
                    target[OBJECT_KEYS].push( keys[i] );
                    target[ keys[i] ]= values[i];
                }
                return new Proxy( target, sortedObjectProxyHandler );
            }
            
            var o= sortedObject( [1, -1, 2, -2], ['one', 'minus one', 'two', 'minus two'] );

            document.write( Object.keys( o ) );
            
            document.write( '<br/><br/>' );
            for( var i in o ) {
                document.write( '' +i+ ' ' );
            }
        </script>
    </head>
    <body>
    </body>
</html>
